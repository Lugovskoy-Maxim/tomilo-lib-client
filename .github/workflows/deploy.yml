name: Deploy Next.js client to home server

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Next.js client to home server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT || 22 }}
          script: |
            echo "üöÄ Deploying Next.js client to server..."

            # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            PROJECT_DIR="/home/${{ secrets.VM_USERNAME }}/tomilo-lib-client"
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            echo "Current directory: $(pwd)"

            # –ö–ª–æ–Ω–∏—Ä—É–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —á–µ—Ä–µ–∑ HTTPS (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç SSH –∫–ª—é—á–∞)
            if [ ! -d .git ]; then
              echo "Cloning repository for the first time..."
              git clone https://github.com/${{ github.repository }}.git .
            else
              echo "Updating existing repository..."
              git fetch origin
              git reset --hard origin/main
            fi

            # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫
            echo "üîß Creating Next.js config to ignore build errors..."
            cat > next.config.js << 'EOF'
            /** @type {import('next').NextConfig} */
            const nextConfig = {
              typescript: {
                ignoreBuildErrors: true,
              },
              eslint: {
                ignoreDuringBuilds: true,
              },
            }
            
            module.exports = nextConfig
            EOF

            echo "Next.js config created:"
            cat next.config.js

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–∞–ø–∫–µ
            echo "Project contents:"
            ls -la
            echo "Package.json exists: $(test -f package.json && echo 'YES' || echo 'NO')"

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js —á–µ—Ä–µ–∑ nvm
            echo "üîß Setting up Node.js 20..."
            if [ -s "$HOME/.nvm/nvm.sh" ]; then
              source "$HOME/.nvm/nvm.sh"
            else
              echo "Installing nvm..."
              curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash
              source "$HOME/.nvm/nvm.sh"
            fi

            if ! nvm ls 20 &> /dev/null; then
              echo "Installing Node.js 20..."
              nvm install 20
            fi
            nvm use 20
            nvm alias default 20

            echo "Node.js version: $(node --version)"
            echo "npm version: $(npm --version)"

            # –ö–æ–ø–∏—Ä—É–µ–º .env –∏–∑ –ø—Ä–∏–º–µ—Ä–∞, –µ—Å–ª–∏ –Ω–µ—Ç
            if [ -f .env.example ] && [ ! -f .env ]; then
              cp .env.example .env
              echo "‚úÖ .env created from example"
            fi

            # –û–±–Ω–æ–≤–ª—è–µ–º .env –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
            if [ -f .env ]; then
              sed -i 's|NEXT_PUBLIC_API_URL=.*|NEXT_PUBLIC_API_URL=https://tomilo-lib.ru/api|g' .env
              sed -i 's/NODE_ENV=development/NODE_ENV=production/g' .env
              echo "‚úÖ Updated .env for production"
            fi

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "Installing dependencies..."
            rm -rf node_modules .next
            npm install

            # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç –ë–ï–ó Turbopack
            echo "üî® Building Next.js application (without Turbopack)..."
            
            # –í—Ä–µ–º–µ–Ω–Ω–æ –∏–∑–º–µ–Ω—è–µ–º package.json —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å --turbopack
            if grep -q '"build":.*--turbopack' package.json; then
              echo "Removing --turbopack from build script..."
              sed -i 's/"build":.*next build --turbopack"/"build": "next build"/g' package.json
            fi
            
            # –í—ã–ø–æ–ª–Ω—è–µ–º —Å–±–æ—Ä–∫—É
            npm run build

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏
            echo "üîç Checking build results..."
            if [ -d ".next" ]; then
              echo "‚úÖ .next directory exists"
              echo "Contents of .next:"
              ls -la .next/ || echo "Cannot list .next contents"
              
              if [ -f ".next/BUILD_ID" ]; then
                echo "‚úÖ BUILD_ID exists - production build is ready"
                echo "BUILD_ID: $(cat .next/BUILD_ID)"
              else
                echo "‚ùå BUILD_ID not found - build may be incomplete"
                exit 1
              fi
            else
              echo "‚ùå .next directory does not exist - build failed"
              exit 1
            fi

            # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ pm2
            echo "üîÑ Starting Next.js application with PM2..."
            
            # –°–æ–∑–¥–∞–µ–º ecosystem —Ñ–∞–π–ª –¥–ª—è PM2
            cat > ecosystem.config.js << 'EOF'
            module.exports = {
              apps: [{
                name: 'tomilo-lib-client',
                script: 'node_modules/next/dist/bin/next',
                args: 'start',
                instances: 1,
                exec_mode: 'fork',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3000
                },
                error_file: './logs/err.log',
                out_file: './logs/out.log',
                log_file: './logs/combined.log',
                time: true
              }]
            }
            EOF

            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π
            pm2 stop tomilo-lib-client 2>/dev/null || true
            pm2 delete tomilo-lib-client 2>/dev/null || true
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç 3000
            echo "üîç Checking port 3000..."
            netstat -tlnp | grep 3000 || echo "Port 3000 is free"
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            pm2 start ecosystem.config.js
            
            # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫
            sleep 10

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "PM2 process list:"
            pm2 ls

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å
            echo "üîç Checking if application is running..."
            if pm2 show tomilo-lib-client | grep -q "online"; then
              echo "‚úÖ PM2 process is online"
            else
              echo "‚ùå PM2 process is not online"
              pm2 logs tomilo-lib-client --lines 20
              exit 1
            fi

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç
            echo "üîç Checking if application responds..."
            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "‚úÖ Next.js application is running successfully on port 3000"
            else
              echo "‚ö†Ô∏è Application might be starting, checking logs..."
              pm2 logs tomilo-lib-client --lines 10
              # –î–∞–µ–º –µ—â–µ –≤—Ä–µ–º–µ–Ω–∏
              sleep 10
              if curl -f http://localhost:3000 > /dev/null 2>&1; then
                echo "‚úÖ Application started successfully after delay"
              else
                echo "‚ùå Application failed to start after multiple attempts"
                exit 1
              fi
            fi

            echo "‚úÖ Successfully deployed Next.js client on server!"
